# modifier-generate-consumer-id

Sample code for IBM(R) WebSphere(R) Service Registry and Repository (WSRR) showing how you can automate the generation of consumer and context identifiers when a version or service level agreement(SLA) is created. 

The context and consumer IDs function as application keys when calling a service through an IBM DataPower Gateway, therefore generating these can be preferred to having to specify them by hand.

The sample is a custom Java modifier plug-in for WSRR.

The sample shows how to correctly update an object when the object is created, and how to insert trace into your custom plug-ins to help with problem determination.

## Details

The code is in the `src` folder. 

### ContextConsumerIDGen.java

The Java modifier plug-in which, when an object is created, checks that it is an Application or Service Version, or an SLA, and if so, generates a UUID and updates the object's context or consumer ID field with the UUID value.

Note that the plug-in re-retrieves the created object before making any updates to it. This is very important to ensure any changes made by other plug-ins are not lost. 

The code uses the Java logging framework to declare a logger for `com.ibm.sr.idgen` and write statements to if the logging level is high, or an error occurs. The Java logging framework integrates with WebSphere Application Server (WAS) diagnostic trace and so the log statements can be enabled for problem determination.

## Configuration

To use the custom modifier plug-in you need to import it into a WSRR profile in WSRR Studio:

1. Open WSRR Studio.

2. Use your existing profile, or create a new WSRR Profile project. See [Creating a new configuration project](http://www-01.ibm.com/support/knowledgecenter/SSWLGF_8.5.5/com.ibm.sr.studio.doc/twsr_mansrvce_studio_new_proj.html).

3. Import into WSRR Studio
	1. Right click the src folder and select Import...
	2. Select File System and click Next.
	3. Click Browse next to From directory.
	4. Navigate to the repository directory, select `src` and click OK.
	5. In the Import dialog, click Select All.
	6. Click Finish.

Next you compile the plug-in and publish it into WSRR:

1. In WSRR Studio, from the WSRR Configuration perspective, right click the WSRR Profile project folder and select General All WSRR Artifacts.

2. In WSRR Studio, expand `Configuration Profile Files/Modifiers` and edit the Modification property plug-in file to add the modifier `com.ibm.sr.idgen.ContextConsumerIDGen` on the `modifiers` line. For example if the original line is:

`modifiers=com.ibm.ws.wspolicy.dd.modifier.DynamicDomainModifier,com.ibm.serviceregistry.wmq.Parser,com.ibm.sr.config.modifier.ConfigurableModifier`

Then change the line to:

`modifiers=com.ibm.ws.wspolicy.dd.modifier.DynamicDomainModifier,com.ibm.serviceregistry.wmq.Parser,com.ibm.sr.config.modifier.ConfigurableModifier,com.ibm.sr.idgen.ContextConsumerIDGen`

3. Either publish the WSRR profile to your WSRR server, or synchronize the profile, or individually publish the files. The files to publish are the JAR `Configuration Profile Files/PLUGIN_JAR/projectname.jar` (where projectname is the name of the WSRR Profile project) and the modifier configuration `Configuration Profile Files/Modifiers/Modification property plug-in`. See [Exporting a profile to Websphere Service Registry and Repository](http://www-01.ibm.com/support/knowledgecenter/SSWLGF_8.5.5/com.ibm.sr.studio.doc/twar_exporting_profile_file_system.html) or [Partially publishing individual files](http://www-01.ibm.com/support/knowledgecenter/SSWLGF_8.5.5/com.ibm.sr.studio.doc/twsr_partially_publish_indiv_files.html) or [Synchronizing the configuration profile with WSRR](http://www-01.ibm.com/support/knowledgecenter/SSWLGF_8.5.5/com.ibm.sr.studio.doc/twsr_publishing_profile_partially.html). If you partially publish the files individually, ensure you publish the JAR before the modifier configuration.

## Testing

To test the ID generation you need to:

1. Create a service version in the WSRR UI.
2. Create an SLA in the WSRR UI.
3. Examine the details of the service version and SLA.

The version will have an entry in the Consumer Identifier field such as `fac28fb9-0d48-4706-b953-0b3e5b119897`. The SLA will have an entry in the Context Identifier field such as `777ae346-9e7b-4f4e-8709-c903b0679e1a`. These values were generated by the custom plug-in.

To test trace you need to:

1. In the WebSphere Application Server (WAS) administrative console for the WSRR server, enable trace for the plug-in by:
	1. Expand Troubleshooting -> Logs and Trace.
	2. Click the name of the server, for example `server1`.
	3. Click Change log detail levels.
	4. Click the Runtime tab.
	5. In the trace string text entry box, add `:com.ibm.sr.idgen=all` at the end, or alternatively expand Components and Groups and enable all trace for `com.ibm.sr.idgen`.
	6. Click OK to save your changes to the trace components.

2. Create a service version or SLA in the WSRR UI.
3. Examine the WAS trace.

The trace output will contain entry and exit trace for the plug-in such as:

`[08/07/15 11:32:58:513 BST] 0000013e idgen         > com.ibm.sr.idgen.ContextConsumerIDGen create ENTRY com.ibm.serviceregistry.sdo.impl.GenericObjectImpl@60ad762 (classificationURIs: [http://www.ibm.com/xmlns/prod/serviceregistry/profile/v6r3/GovernanceEnablementModel#ApplicationVersion], bsrURI: 8e3b9b8e-550d-4d8d.a7ce.cd06edcdcec5, name: Test App 23, namespace: null, version: 1.0, description: , owner: admin, lastModified: 1436351577498, creationTimestamp: 1436351577498, lastModifiedBy: admin) (primaryType: http://www.ibm.com/xmlns/prod/serviceregistry/profile/v6r3/GovernanceEnablementModel#ApplicationVersion)`

`[08/07/15 11:32:59:670 BST] 0000013e idgen         < com.ibm.sr.idgen.ContextConsumerIDGen create RETURN SUCCESS: `

## License

Licensed under the Apache License, Version 2.0 (the "License"). See license.txt.